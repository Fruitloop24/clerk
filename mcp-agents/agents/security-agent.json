{
  "agent_name": "security-agent",
  "version": "1.0.0",
  "description": "JWT authentication, CORS, webhook security, and secrets management specialist",
  "role": "Security & Compliance Officer",
  "personality": "Zero-tolerance for production security gaps, pragmatic in development",
  
  "knowledge_bases": ["../base/security-knowledge.json"],
  "context_files": [
    "../../CLAUDE.md",
    "../../README.md",
    "../../api/src/index.ts",
    "../../api/src/stripe-webhook.ts",
    "../../api/wrangler.toml",
    "../../.gitignore"
  ],
  
  "core_responsibilities": {
    "cors_hardening": "Replace wildcard CORS with production domain whitelist",
    "jwt_validation": "Ensure all protected endpoints verify Clerk JWT tokens correctly",
    "webhook_security": "Enforce Stripe signature verification in production environment",
    "secrets_management": "Prevent secret leakage, validate environment variables",
    "rate_limiting": "Implement and monitor per-user API rate limits"
  },
  
  "resolved_issues": {
    "BLOCKER_1_CORS_WILDCARD": {
      "severity": "CRITICAL (RESOLVED)",
      "fixed_date": "2025-10-19",
      "implementation": "Dynamic origin validation with env-configurable allowlist",
      "location": "api/src/index.ts:140-165",
      "validation": "CORS now restricts to whitelisted domains, rejects unauthorized origins"
    },
    "BLOCKER_2_WEBHOOK_SECRET_OPTIONAL": {
      "severity": "CRITICAL (RESOLVED)",
      "fixed_date": "2025-10-19",
      "implementation": "Fail-hard if STRIPE_WEBHOOK_SECRET missing",
      "location": "api/src/stripe-webhook.ts:29-36",
      "validation": "Webhook endpoint now requires secret, rejects unsigned requests"
    }
  },

  "critical_issues": {
    "MEDIUM_ENV_VALIDATION_TIMING": {
      "severity": "MEDIUM",
      "blocks_production": false,
      "location": "api/src/index.ts (worker startup)",
      "current_code": "validateEnv() called on first request instead of worker startup",
      "security_risk": "Worker starts with missing env vars, fails on first user request",
      "required_fix": "Move environment validation to worker initialization",
      "code_fix": {
        "location": "After export default { async fetch(...) } declaration",
        "add_code": "\n// Validate environment on worker startup\nconst envCheck = validateEnv(env);\nif (!envCheck.valid) {\n\tthrow new Error(`Missing required environment variables: ${envCheck.missing.join(', ')}`);\n}"
      },
      "validation": "Test that worker fails to start with missing required env vars",
      "acceptance_criteria": [
        "Worker fails fast on startup if env vars missing",
        "Clear error message lists missing variables",
        "No user requests processed with invalid config"
      ]
    },
    "MEDIUM_RATE_LIMIT_KV_RACE": {
      "severity": "MEDIUM",
      "blocks_production": false,
      "location": "api/src/index.ts:114-168 (handleDataRequest)",
      "current_code": "KV read → increment → write (not atomic)",
      "security_risk": "Concurrent requests can bypass free tier limit",
      "required_fix": "Use Durable Objects for atomic counters or implement optimistic locking",
      "mitigation": "Document as known limitation, monitor for abuse patterns",
      "future_improvement": "Migrate to Durable Objects for atomic operations"
    }
  },
  
  "security_checklist": {
    "before_production_deployment": [
      "✅ CORS configured with production domain whitelist (RESOLVED 2025-10-19)",
      "✅ STRIPE_WEBHOOK_SECRET required and verified (RESOLVED 2025-10-19)",
      "✓ All secrets set via 'wrangler secret put'",
      "⚠️ Environment validation at worker startup (PENDING)",
      "✓ Rate limiting tested under load (100 req/min)",
      "✓ JWT token validation tested with invalid tokens",
      "✓ No secrets in .git history (check with git log -p)",
      "✓ .gitignore covers all secret files (.env, .dev.vars)"
    ],
    "ongoing_monitoring": [
      "Monitor rate limit hits and potential abuse",
      "Review failed authentication attempts",
      "Track webhook signature validation failures",
      "Audit environment variable changes",
      "Monitor for unusual usage patterns"
    ]
  },
  
  "tools_required": {
    "str_replace": "Edit files to fix security issues",
    "bash": "Run git log to check for leaked secrets",
    "file_create": "Create security test files"
  },
  
  "automation_triggers": [
    "CORS wildcard detected → Block deployment + alert",
    "Webhook secret missing → Fail CI/CD pipeline",
    "Environment validation missing → Fail startup",
    "Rate limit exceeded → Log + investigate abuse",
    "JWT verification failed > 10/hour → Alert security team",
    "Secret found in git history → Rotate + notify"
  ],
  
  "typical_tasks": [
    {
      "task": "Move env validation to worker startup",
      "steps": [
        "1. Move validateEnv call to worker initialization",
        "2. Throw error if validation fails",
        "3. Test worker startup with missing env vars",
        "4. Verify clear error messages",
        "5. Document required env vars"
      ],
      "estimated_time": "10 minutes",
      "blocking": false
    },
    {
      "task": "Scan for leaked secrets",
      "steps": [
        "1. Run 'git log -p | grep -i \"CLERK_SECRET\\|STRIPE_SECRET\"'",
        "2. Check .gitignore includes .env* and .dev.vars",
        "3. Verify wrangler.toml has no secrets",
        "4. Scan for hardcoded API keys in source",
        "5. Generate secret rotation plan if found"
      ],
      "estimated_time": "15 minutes",
      "blocking": false
    }
  ],
  
  "emergency_procedures": {
    "secret_leaked_in_git": {
      "immediate_actions": [
        "1. Rotate compromised secret immediately",
        "2. Revoke old secret in Clerk/Stripe dashboard",
        "3. Deploy with new secret via 'wrangler secret put'",
        "4. Audit access logs for suspicious activity",
        "5. Consider git history rewrite if recent"
      ],
      "notification": "Alert team immediately, document incident"
    },
    "jwt_attack_detected": {
      "immediate_actions": [
        "1. Check Clerk dashboard for compromised users",
        "2. Verify JWT validation logic is correct",
        "3. Review rate limiting effectiveness",
        "4. Consider temporary IP blocking if attack ongoing",
        "5. Enable detailed request logging"
      ],
      "escalation": "Contact Clerk support if validation bypass suspected"
    },
    "webhook_fraud_attempt": {
      "immediate_actions": [
        "1. Verify signature verification is active",
        "2. Check Stripe dashboard for fraudulent events",
        "3. Review recent subscription changes",
        "4. Temporarily disable webhook if actively exploited",
        "5. Audit all recent plan upgrades"
      ],
      "escalation": "Contact Stripe support, file fraud report"
    }
  },
  
  "compliance_notes": {
    "data_retention": "Receipt data via Stripe, audit Clerk's data policies",
    "gdpr": "Users can delete account via Clerk, verify data deletion",
    "secrets_rotation": "Rotate secrets quarterly or after suspected compromise",
    "audit_logging": "KV stores usage, consider adding request logging"
  },
  
  "success_metrics": {
    "cors_fixed": "✅ ACHIEVED - No wildcard in production, domain-restricted (2025-10-19)",
    "webhook_secured": "✅ ACHIEVED - 100% signature verification in production (2025-10-19)",
    "env_validated": "⚠️ PENDING - Worker fails fast on missing env vars",
    "zero_secrets_leaked": "No API keys in git history",
    "rate_limiting_effective": "Abuse attempts blocked successfully"
  }
}